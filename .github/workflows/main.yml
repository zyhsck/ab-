name: Watch Face Generator with Auto-Cleanup

on:
  repository_dispatch:
    types: [generate_watchface]
  workflow_dispatch:
    inputs:
      input_json:
        description: 'JSON containing model path and image Base64'
        required: true

jobs:
  generate:
    runs-on: windows-latest
    permissions:
      contents: write
    timeout-minutes: 15
      
    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Increase virtual memory
      - name: Increase virtual memory to 16GB
        run: |
          wmic computersystem set AutomaticManagedPagefile=False || echo "AutomaticManagedPagefile already disabled"
          wmic pagefileset create name="C:\pagefile.sys" || echo "Pagefile already exists"
          wmic pagefileset where name="C:\pagefile.sys" set InitialSize=16384,MaximumSize=16384 || echo "Pagefile size already set"
          wmic pagefileset list brief
          echo "Virtual memory increased to 16GB"
        shell: cmd

      # 3. Process input data
      - name: Parse input JSON
        id: parse-input
        run: |
          $inputData = if ('${{ github.event_name }}' -eq 'repository_dispatch') {
            '${{ toJson(github.event.client_payload.input_json) }}'
          } else {
            '${{ toJson(github.event.inputs.input_json) }}'
          }
          
          $jsonInput = $inputData | ConvertFrom-Json
          $jsonInput.model | Out-File "$env:RUNNER_TEMP\model_path.txt"
          $jsonInput.file | Out-File "$env:RUNNER_TEMP\image_base64.txt" -NoNewline
          
          echo "model_path_file=$env:RUNNER_TEMP\model_path.txt" >> $env:GITHUB_OUTPUT
          echo "base64_file=$env:RUNNER_TEMP\image_base64.txt" >> $env:GITHUB_OUTPUT

      # 4. Prepare project files
      - name: Prepare project directory
        id: prepare-project
        run: |
          $modelPath = Get-Content "$env:RUNNER_TEMP\model_path.txt"
          $projectDir = "project"
          New-Item -Type Directory -Path $projectDir -Force
          
          # 复制整个模板目录结构
          $sourceTemplateDir = Split-Path $modelPath -Parent
          Copy-Item "$sourceTemplateDir\*" $projectDir -Recurse -Force
          
          # 查找并重命名FPRJ文件
          $fprjFile = Get-ChildItem $projectDir -Filter "*.fprj" -Recurse | Select-Object -First 1
          if ($fprjFile) {
              $newFprjPath = Join-Path $fprjFile.Directory "fprj.fprj"
              Rename-Item $fprjFile.FullName $newFprjPath -Force
              Write-Output "Renamed project file: $($fprjFile.FullName) -> $newFprjPath"
          } else {
              Write-Error "No FPRJ file found"
              exit 1
          }
          
          # 获取Base64内容
          $base64Content = Get-Content "${{ steps.parse-input.outputs.base64_file }}" -Raw
          
          # 检查Base64数据长度
          if ($base64Content.Length -lt 100) {
              Write-Warning "Base64 data is too short: $($base64Content.Length) characters. Using default image."
          } else {
              try {
                  # 解码Base64数据
                  $bytes = [Convert]::FromBase64String($base64Content)
                  
                  # 查找images目录
                  $imagesDir = Get-ChildItem $projectDir -Filter "images" -Recurse | Select-Object -First 1
                  if (-not $imagesDir) {
                      $imagesDir = Join-Path $projectDir "images"
                      New-Item -Type Directory -Path $imagesDir -Force
                  }
                  
                  # 保存背景图
                  $picPath = Join-Path $imagesDir.FullName "pic.png"
                  [IO.File]::WriteAllBytes($picPath, $bytes)
                  Write-Output "Saved background image to: $picPath"
                  
                  # 保存预览图
                  $prePath = Join-Path $imagesDir.FullName "pre.png"
                  Copy-Item $picPath $prePath -Force
                  Write-Output "Saved preview image to: $prePath"
              } catch {
                  Write-Warning "Failed to process image data: $_"
              }
          }
          
          # 创建输出目录
          New-Item -Type Directory -Path "$projectDir\output" -Force
          
          # 输出路径变量
          echo "project_path=$projectDir" >> $env:GITHUB_OUTPUT
          echo "fprj_path=$newFprjPath" >> $env:GITHUB_OUTPUT

      # 5. Set up Python
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 6. Install Pillow for image processing
      - name: Install dependencies
        run: pip install Pillow

      # 7. Run compilation script
      - name: Compile Watch Face
        env:
          PROJECT_PATH: "${{ steps.prepare-project.outputs.fprj_path }}"
          OUTPUT_DIR: "${{ github.workspace }}/output"
        run: python compile_watchface.py
      
      # 8. Verify output
      - name: Verify Output File
        id: verify-output
        run: |
          $file = Get-ChildItem "${{ github.workspace }}/output" -Filter "*.face"
          if ($file) {
              echo "face_file=$($file.FullName)" >> $env:GITHUB_OUTPUT
          } else {
              Write-Error "Output file not found"
              exit 1
          }
      
      # 9. Create Release
      - name: Create Release
        id: create-release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          tag_name: "face-${{ github.run_id }}"
          files: ${{ steps.verify-output.outputs.face_file }}
          draft: false
          prerelease: false

      # 10. Pass release data
      - name: Store Release Data
        id: pass-data
        run: |
          echo "release_id=${{ steps.create-release.outputs.id }}" >> $env:GITHUB_OUTPUT
          echo "release_tag=face-${{ github.run_id }}" >> $env:GITHUB_OUTPUT
    
    outputs:
      release_id: ${{ steps.pass-data.outputs.release_id }}
      release_tag: ${{ steps.pass-data.outputs.release_tag }}

  delete_release:
    name: Auto-Delete Release
    needs: generate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # 1. Wait 10 minutes (using native sleep)
      - name: Wait for 10 minutes
        run: sleep 600
      
      # 2. Delete release and tag
      - name: Delete Release Assets
        uses: actions/github-script@v6
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          script: |
            const { release_id, release_tag } = {
              release_id: ${{ needs.generate.outputs.release_id }},
              release_tag: '${{ needs.generate.outputs.release_tag }}'
            };
            
            if (!release_id || !release_tag) {
              core.setFailed('Missing release information');
              return;
            }
            
            try {
              // Delete release
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release_id
              });
              
              // Delete tag
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${release_tag}`
              });
              
              core.info(`Successfully deleted release ${release_id} and tag ${release_tag}`);
            } catch (error) {
              if (error.status === 404) {
                core.warning('Release or tag not found (may have been already deleted)');
              } else {
                core.setFailed(`Deletion failed: ${error.message}`);
              }
            }
